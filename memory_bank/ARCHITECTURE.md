# 水泳部練習メニュー作成アプリ - アーキテクチャ設計書

## 概要

本アプリケーションは、AIを活用して水泳部向けの練習メニューを自動生成するWebアプリケーションです。2024年8月にUpstashからNeon Databaseへの移行を完了し、より安定したデータベースサービスを提供しています。

## システムアーキテクチャ

### フロントエンド
```
┌─────────────────────────────────────────────────────────────┐
│                    Next.js 15 (App Router)                  │
├─────────────────────────────────────────────────────────────┤
│  React 19 + TypeScript 5 + Tailwind CSS + Radix UI        │
│                                                             │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐          │
│  │   メニュー   │ │   アップロード │ │   履歴表示   │          │
│  │   生成画面   │ │     画面     │ │     画面     │          │
│  └─────────────┘ └─────────────┘ └─────────────┘          │
└─────────────────────────────────────────────────────────────┘
```

### バックエンド
```
┌─────────────────────────────────────────────────────────────┐
│                    API Routes (Next.js)                    │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐          │
│  │ generate-   │ │   get-menu  │ │ search-     │          │
│  │   menu      │ │             │ │  similar-   │          │
│  │             │ │             │ │   menus     │          │
│  └─────────────┘ └─────────────┘ └─────────────┘          │
│                                                             │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐          │
│  │  upload-    │ │ menu-       │ │   init-db   │          │
│  │   menu      │ │  history    │ │             │          │
│  │             │ │             │ │             │          │
│  └─────────────┘ └─────────────┘ └─────────────┘          │
└─────────────────────────────────────────────────────────────┘
```

### データストレージ
```
┌─────────────────────────────────────────────────────────────┐
│                    Neon Database                            │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────┐   │
│  │                PostgreSQL + pgvector               │   │
│  │                                                     │   │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐   │   │
│  │  │   menus     │ │ menu_data   │ │   vector    │   │   │
│  │  │  (metadata) │ │ (JSON data) │ │  indexes    │   │   │
│  │  └─────────────┘ └─────────────┘ └─────────────┘   │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

## データベース設計

### テーブル構造

#### 1. `menus` テーブル
```sql
CREATE TABLE menus (
  id VARCHAR(255) PRIMARY KEY,
  title VARCHAR(500),
  description TEXT,
  metadata JSONB,
  embedding vector(1536),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

**用途**: メニューのメタデータとベクトル埋め込みを保存
**インデックス**: `menus_embedding_idx` (pgvector用)

#### 2. `menu_data` テーブル
```sql
CREATE TABLE menu_data (
  id VARCHAR(255) PRIMARY KEY,
  menu_data JSONB NOT NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

**用途**: メニューの完全なデータ（JSON形式）を保存

### ベクトル検索（pgvector）

```sql
-- 類似メニュー検索
SELECT 
  id, 
  metadata, 
  1 - (embedding <=> $1::vector) as similarity
FROM menus 
WHERE embedding IS NOT NULL
ORDER BY embedding <=> $1::vector 
LIMIT 5;
```

## AI統合アーキテクチャ

### サポートAIモデル
1. **OpenAI GPT-4o** - メニュー生成・埋め込み生成
2. **Google Gemini** - メニュー生成
3. **Anthropic Claude** - メニュー生成

### RAG（Retrieval-Augmented Generation）フロー
```
1. ユーザー入力 → 2. クエリベクトル化 → 3. pgvector検索 → 4. 類似メニュー取得 → 5. AIプロンプトに統合 → 6. メニュー生成
```

## 移行履歴

### Upstash → Neon 移行（2024年8月完了）

**移行理由**:
- Upstash無料プランの2週間制限
- Neonの永続的な無料プラン（月500MB + 10GB転送）

**移行内容**:
- Redis → PostgreSQL + pgvector
- Upstash Vector → pgvector
- データベース接続の完全書き換え
- APIルートの更新

**移行後の利点**:
- ✅ 永続的な無料プラン
- ✅ より柔軟なスキーマ設計
- ✅ 高速なベクトル検索
- ✅ サーバーレス自動スケーリング

## セキュリティ設計

### APIキー管理
- フロントエンドでの直接入力（環境変数非使用）
- 各AIサービスごとの個別APIキー
- 埋め込み生成用のOpenAI APIキー

### データベースセキュリティ
- SSL接続必須（`sslmode=require`）
- 環境変数による接続文字列管理
- パラメータ化クエリによるSQLインジェクション対策

## パフォーマンス最適化

### ベクトル検索
- pgvectorの`ivfflat`インデックス使用
- コサイン類似度による高速検索
- 時間範囲での絞り込み

### キャッシュ戦略
- メニューデータの永続化
- メタデータの高速アクセス
- ベクトル埋め込みの事前計算

## 監視・ログ

### ログレベル
- `[API]` - APIルートの実行状況
- `[Neon]` - データベース操作
- `[KV]` - レガシー（削除予定）

### エラーハンドリング
- 段階的なフォールバック処理
- ユーザーフレンドリーなエラーメッセージ
- 詳細なデバッグ情報（開発環境）

## 今後の拡張計画

### 短期（1-3ヶ月）
- [ ] メニュー編集機能
- [ ] ユーザー認証システム
- [ ] メニュー共有機能

### 中期（3-6ヶ月）
- [ ] 複数言語対応
- [ ] モバイルアプリ
- [ ] 高度な分析機能

### 長期（6ヶ月以上）
- [ ] 機械学習によるメニュー最適化
- [ ] リアルタイム協調フィルタリング
- [ ] 予測分析機能

## 技術的負債

### 現在の課題
- [ ] 一部のレガシーログ（`[KV]`）の残存
- [ ] エラーハンドリングの統一化
- [ ] テストカバレッジの向上

### 改善計画
- [ ] ログシステムの統一
- [ ] エラーハンドリングの標準化
- [ ] E2Eテストの自動化

## 結論

Neon Databaseへの移行により、アプリケーションの安定性とスケーラビリティが大幅に向上しました。pgvectorによる高速なベクトル検索と、PostgreSQLの柔軟性を活かした設計により、今後の機能拡張にも対応できる堅牢な基盤が構築されています。
